<extend name="Public/base"/>

<block name="header">
    <include file="modal"/>
</block>

<!-- 子导航 -->
<block name="sidebar">
    <include file="Public/sidemenu"/>
</block>

<block name="content">
    <!-- 标题 -->
    <div class="ell-main-title">
        <h2>基础信息设置 [年级班级设置]
        </h2>
    </div>

    <!-- 按钮工具栏 -->
    <div class="row">
        <div class="col-md-6">
            <div class="pull-left">
                <button class="btn btn-success" data-toggle="modal" data-target="#myModal">新 增</button>
                <button class="btn btn-success ajax-post" data-target="[data-check='ids']" data-confirm="确认要删除吗?" data-url="">删 除</button>
            </div>
        </div>
    </div>

    <!-- 数据表格 -->
    <div class="data-table">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th class="row-selected"><input type="checkbox" data-toggle="checkall" data-target="ids"/></th>
                    <th>年级</th>
                    <th>备注名</th>
                    <th>班级</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <foreach name="class_tree" item="vo" key="k">
                <tr id="{$k}" data-info-grade="{$vo.grade_number}" data-info-classes="2">
                    <td><input type="checkbox" data-check="ids" name="ids[]" value="{$vo.grade_number}"></td>
                    <td>{$vo.grade_number}</td>
                    <td><a>{$vo.name}<i class="fa fa-edit fa-lg text-primary"></i></a></td>
                    <td>
                    	<foreach name="vo._" item="class">
                        <span class="label label-primary">{$class.name}</span>
                        </foreach>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-xs" data-table-btn="inc" data-target="#{$k}">
                            <span class="glyphicon glyphicon-plus"></span>
                        </button>
                        <button class="btn btn-danger btn-xs" data-table-btn="dec" data-target="#{$k}">
                            <span class="glyphicon glyphicon-minus"></span>
                        </button>
                    </td>
                </tr>
                </foreach>
            </tbody>
        </table>
    </div>
</block>

<block name="script">
    <script>
    $(function(){

        $("[data-table-btn]").click(function() {
            var op = $(this).attr("data-table-btn");
            var targetTr = $(this).attr("data-target");
            var grade = $(targetTr).attr("data-info-grade");
            var url = U("Usercenter/Tuser/gradeSetting");
            var method = op == "dec" ? -1 : 1;
            $.post(url, {grade: grade, status: method}, function (data) {
                handleAjax(data);
                if (data.status) {
                    updateClasses(data.grade, data.classes);
                }
            })
        });

        // 初始化Modal
        // $(".init").click(function() {
        //     var gradeInfo = $("[data-grade]").last();
        //     if(gradeInfo.length == 1){ //找到年级列表最后一行
        //         var classesInfo = gradeInfo.next().next();
        //         var grade = parseInt(gradeInfo.attr("data-grade"));
        //         var classes = parseInt(classesInfo.attr("data-classes"));

        //         $("input[name=grade]").attr("value", grade + 1);
        //         $("input[name=classes]").attr("value", classes);
        //     }
        // });
    });

    function updateClasses(grade, classes) {
        var targetTr = $("[data-info-grade=" + grade + "]");
        targetTr.attr("data-info-classes", classes);
        var classesTd = $("td", targetTr).eq(3);
        var html = "";
        for(i=1;i<=classes;i++){
            html += "<span class='label label-primary'>" + i +" 班</span> ";
        }
        classesTd.html(html);
    }
    </script>
</block>
