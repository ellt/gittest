<extend name="Public/base"/>

<block name="header">
    <!-- 新增年级Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">关闭</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">新增年级</h4>
                </div>
                <div class="modal-body">
                    <form id="addGradeForm" role="form" action="{:U('User/addGrade')}" method="post">
                        <div class="row">
                            <div class="col-sm-3">
                                <h4 class="pull-right">年级：</h4>
                            </div>
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" id="decGrade" type="button">
                                            <span class="glyphicon glyphicon-minus"></span>
                                        </button>
                                    </span>
                                    <input type="text" class="form-control" id="setGrade" name="grade" value="2015" readonly>                    
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" id="incGrade" type="button">
                                            <span class="glyphicon glyphicon-plus"></span>
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="row"><!--错误时 class="has-error" -->
                            <div class="col-sm-3">
                                <h4 class="pull-right">备注名：</h4>
                            </div>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" name="gradename" value="">
                            </div>
                            <div class="col-sm-5">
                                <div class="help-block hidden">
                                    <span class="glyphicon glyphicon-remove"></span>
                                    <span>格式错误</span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-3">
                                <h4 class="pull-right">班级数量：</h4>
                            </div>
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" id="decClass" type="button">
                                            <span class="glyphicon glyphicon-minus"></span>
                                        </button>
                                    </span>
                                    <input type="text" id="setClass" class="form-control" name="classes" value="4">
                                    <span class="input-group-btn">
                                        <button class="btn btn-default" id="incClass" type="button">
                                            <span class="glyphicon glyphicon-plus"></span>
                                        </button>
                                    </span>
                                </div>
                            </div>
                            <div class="col-sm-5">
                                <div class="help-block hidden">
                                    <span class="glyphicon glyphicon-remove"></span>
                                    <span>格式错误</span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <input type="submit" class="btn btn-primary" value="确定" form="addGradeForm"/>
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>
</block>
<!-- 子导航 -->
<block name="sidebar">
    <include file="sidemenu" />
</block>

<block name="content">
    <!-- 标题 -->
    <div class="ell-main-title">
        <h2>基础信息设置({$_total})</h2>
    </div>

    <!-- 按钮工具栏 -->
    <div class="row">
        <div class="col-md-6">
            <div class="pull-left">
                <button class="btn btn-success init" data-toggle="modal" data-target="#myModal">新 增</button>
                <button class="btn btn-success ajax-post confirm" target-form="ids" url="{:U("Article/setStatus",array("status"=>-1))}">删 除</button>
            </div>
        </div>
    </div>

    <!-- 数据表格 -->
    <div class="data-table">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th class="row-selected"><input class="check-all" type="checkbox"/></th>
                    <th>年级</th>
                    <th>备注名</th>
                    <th>班级</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input class="ids" type="checkbox" name="ids[]" value="{$vo.id}" /></td>
                    <td data-grade="2014">2014级</td>
                    <td><a> <i class="fa fa-edit fa-lg text-primary"></i></a></td>
                    <td data-classes="2">
                        <span class="label label-primary">1 班</span>
                        <span class="label label-primary">2 班</span>
                        
                    </td>
                    <td>
                        <button class="btn btn-primary btn-xs get" data-url="{:U('User/baseSetting?grade=2014&status=1')}">
                            <span class="glyphicon glyphicon-plus"></span>
                        </button>
                        <button class="btn btn-danger btn-xs get" data-url="{:U('User/baseSetting?grade=2014&status=-1')}">
                            <span class="glyphicon glyphicon-minus"></span>
                        </button>
                    </td>
                </tr>
                <tr>
                    <td><input class="ids" type="checkbox" name="ids[]" value="{$vo.id}" /></td>
                    <td data-grade="2015">2015级</td>
                    <td><a> <i class="fa fa-edit fa-lg text-primary"></i></a></td>
                    <td data-classes="3">
                        <span class="label label-primary">1 班</span>
                        <span class="label label-primary">2 班</span>
                        <span class="label label-primary">3 班</span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-xs">
                            <span class="glyphicon glyphicon-plus"></span>
                        </button>
                        <button class="btn btn-danger btn-xs">
                            <span class="glyphicon glyphicon-minus"></span>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</block>

<block name="script">
    <script>
    $(function(){
        $(".get").click(function () {
            //获取参数
            var url = $(this).attr('data-url');

            //发送到服务器
            $.get(url).success(function(data){
                if (data.status) {
                    updateClasses(data.grade, data.classes);
                }
            });
        });

        // 新增年级Modal

        // 初始化Modal
        $(".init").click(function() {
            var gradeInfo = $("[data-grade]").last();
            if(gradeInfo.length == 1){ //找到年级列表最后一行
                var classesInfo = gradeInfo.next().next();
                var grade = parseInt(gradeInfo.attr("data-grade"));
                var classes = parseInt(classesInfo.attr("data-classes"));

                $("#setGrade").attr("value", grade + 1);
                $("#setClass").attr("value", classes);
            }
        });

        // 表单合法性校验 
        $("#setClass").change(function() {
            var classes = $(this).val();
            if (isInt(classes) && (0 < parseInt(classes))) {
                var row = $(this).parentsUntil("form").filter(".row");
                row.removeClass("has-error");
                row.find(".help-block").removeClass("show").addClass("hidden");
            } else { // 格式错误
                var row = $(this).parentsUntil("form").filter(".row");
                row.addClass("has-error");
                row.find(".help-block").removeClass("hidden").addClass("show");
            }
        });

        // 处理+/-按钮
        $("#incGrade").click(function() {
            setGrade(1);
        });
        $("#decGrade").click(function() {
            setGrade(-1);
        });
        $("#incClass").click(function() {
            setClasses(1);
        });
        $("#decClass").click(function() {
            setClasses(-1);
        });

        // 确定
        $("#addGradeForm").submit(function (e) {
            //取消默认动作，防止表单两次提交
            e.preventDefault();

            //禁用提交按钮，防止重复提交
            var form = $(this);
            $('[form=addGradeForm]').addClass('disabled');

            //获取提交地址，方式
            var action = form.attr('action');

            //检测提交地址
            if (!action) {
                return false;
            }

            //获取表单内容
            var formContent = form.serialize();

            //发送到服务器
            $.post(action, formContent).success(function(data){
                $('[form=addGradeForm]').removeClass('disabled');
                if (data.status) {
                    //todo 刷新年级列表
                    $('#myModal').modal('hide');
                }
            });
        });
    });

    function setGrade(method) {
        var input = $("#setGrade");
        var grade = parseInt(input.val());
        grade = isNaN(grade) ? parseInt(input.attr("value")) : grade;
        input.val(grade + method);
    }

    function setClasses(method) {
        var input = $("#setClass");
        var classes = parseInt(input.val());
        classes = isNaN(classes) ? parseInt(input.attr("value")) : classes;
        input.val(classes + method);
    }

    function updateClasses(grade, classes) {
        var gradeInfo = $("[data-grade=" + grade + "]");
        var classesInfo = gradeInfo.next().next();
        classesInfo.attr("data-classes", classes);
        var html = "";
        for(i=1;i<=classes;i++){
            html += "<span class='label label-primary'>" + i +" 班</span> ";
        }
        classesInfo.html(html);
    }
    </script>
</block>
