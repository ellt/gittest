<!-- 管理员用户组新增和编辑页面 -->
<extend name="Public/base" />

<!-- 子导航 -->
<block name="sidebar">
    <include file="Public/sidemenu"/>
</block>

<block name="content">
    <!-- 标题栏 -->
    <div class="ell-main-title">
        <h2>权限管理 [ 用户组：
            <select name="group">
                <volist name="auth_group" id="vo">
                <option value="{:U('AuthManager/access',array('group_id'=>$vo['id'],'group_name'=>$vo['title']))}" <eq name="vo['id']" value="$this_group['id']">selected</eq>>
                    {$vo.title}
                </option>
                </volist>
            </select>
        ]</h2>
    </div>

    <div class="ell-tab-wrap">
        <ul class="nav nav-tabs" role="tablist">
            <li class="active"><a href="javascript:;">访问授权</a></li>
            <li><a href="{:U('AuthManager/user',array('group_name'=>I('group_name') ,'group_id'=> I('group_id')))}">成员授权</a></li>
        </ul>

        <div class="tab-content">
            <!-- 访问授权 -->
            <div class="tab-pane active">
                <form class="ajax-form" id="authForm" action="{:U('AuthManager/writeGroup')}" enctype="application/x-www-form-urlencoded" method="POST">
                    <volist name="node_list" id="node" key="all_k">
                        <dl class="checkmod">
                            <dt>
                                <label class="checkbox"><input class="rules_all" type="checkbox" name="rules[]" value="{$main_rules[$node['url']]}">{$node.title}管理</label>
                            </dt>
                            <dd>
                                <present name="node['child']">
                                <volist name="node['child']" id="child" key="row_k">
                                    <div>
                                        <div>
                                            <label class="checkbox" <notempty name="child['tip']">data-content={$child.tip}</notempty>>
                                                <input type="checkbox" data-toggle="checkall" data-target="rules{$all_k}_{$row_k}" name="rules[]" value="{$auth_rules[$child['url']]}"/>{$child.title}
                                            </label>
                                        </div>
                                        <notempty name="child['operator']">
                                        <volist name="child['operator']" id="op">
                                        <label class="checkbox-inline" <notempty name="op['tip']">data-content={$op.tip}</notempty>>
                                           <input type="checkbox" data-check="rules{$all_k}_{$row_k}" name="rules[]"
                                           value="{$auth_rules[$op['url']]}"/>{$op.title}
                                        </label>
                                        </volist>
                                       </notempty>
                                    </div>
                                </volist>
                                </present>
                            </dd>
                        </dl>
                    </volist>

                    <input type="hidden" name="id" value="{$this_group.id}"/>

                    <button type="submit" class="btn btn-success" data-loading-text="提交中……">确 定</button>
                    <button type="button" class="btn btn-danger" onclick="javascript:history.back(-1);return false;">返 回</button>
                </form>
            </div>
            
            <!-- 成员授权 -->
            <div class="tab-pane"></div>
        </div>
    </div>
</block>

<block name="script">
<script>    
    $(function(){
        var rules = [{$this_group.rules}];
        $('input', "#authForm").each(function(){
            if( $.inArray( parseInt(this.value,10),rules )>-1 ){
                $(this).prop('checked',true);
            }
        });

        //全选节点
        $('.rules_all').on('change',function(){
            $(this).parents('dl').find('dd').find('input').prop('checked',this.checked);
        });

        // 提示框
        $('label', "dd").each(function(){
            if ($(this).data('content')) {
                $(this).popover({
                    trigger : "hover",
                    placement : "top",
                    content : $(this).data('content'),
                    title : $(this).text(),
                    container : "body",
                });
            }
        });

        $('select[name=group]').change(function(){
            location.href = this.value;
        });
    });
</script>
</block>
